# Copyright 2020 Energinet DataHub A/S
#
# Licensed under the Apache License, Version 2.0 (the "License2");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
name: Databricks CI

on:
  pull_request:
    branches: 
      - main
  workflow_dispatch:

jobs:
  databricks-ci:
    runs-on: ubuntu-latest
    name: Databricks flake8 and unit test
    steps:

      # https://github.com/marketplace/actions/skip-duplicate-actions
      - name: Skip check
        id: skip_check
        uses: fkirc/skip-duplicate-actions@v1.4.0
        with:
          github_token: ${{ github.token }}
          paths: '["**.py", "build/infrastructure/**", ".github/**", "source/streaming/geh_stream/**"]'

      - name: Checkout
        if: ${{ steps.skip_check.outputs.should_skip == 'false' }}
        uses: actions/checkout@v2

      # https://github.com/TrueBrain/actions-flake8
      - name: Static checks
        if: ${{ steps.skip_check.outputs.should_skip == 'false' }}
        uses: TrueBrain/actions-flake8@master
        with:
          path: ./source
          ignore: E501,F401,E402,W503

      - name: Unit tests
        if: ${{ steps.skip_check.outputs.should_skip == 'false' }}
        uses: ./.github/actions/databricks-unit-test

      - name: Upload build artifacts
        if: ${{ always() && steps.skip_check.outputs.should_skip == 'false' }}
        uses: actions/upload-artifact@v2
        with:
          name: build-databricks_artifacts
          path: ./source/streaming/htmlcov/